/**
 * Test to verify YAML generation includes the websocket token
 */

import yaml from 'js-yaml';

// Mock configuration that would be generated by our modified agent builder
const mockConfig = {
    serverUrl: 'https://test.example.com',
    organizationKey: 'test-key-123',
    agentId: 'agent-test-001',
    websocketToken: 'mock-jwt-token-agent-test-001-12345-67890',
    heartbeatInterval: 60,
    dataUploadInterval: 300,
    scanInterval: 3600,
    registrationEndpoint: '/api/agents/register',
    dataEndpoint: '/api/agents/data',
    heartbeatEndpoint: '/api/agents/heartbeat',
    signMessages: false,
    capabilities: {
        fileSystemMonitoring: true,
        processMonitoring: true,
        networkMonitoring: true,
        registryMonitoring: false,
        securityLogsMonitoring: true,
        malwareScanning: true,
        vulnerabilityScanning: true
    },
    logFilePath: '/var/log/soc-intelligent/agent.log',
    maxStorageSize: 100,
    logLevel: 'info',
    validateCertificates: true,
    maxMessageSize: 1048576,
    allowInsecureConnections: false,
    queueSize: 1000,
    transport: 'websocket',
    compressionEnabled: true,
    enableCommands: true,
    allowedCommands: ['script', 'configUpdate', 'isolate', 'upgrade'],
    directoriesToScan: ['/tmp', '/var/tmp', '/dev/shm', '/home'],
    cpuAlertThreshold: 90
};

// Generate YAML content (simulating generateAgentYamlConfig)
console.log('Testing YAML generation with websocket token...');

try {
    const yamlContent = yaml.dump(mockConfig, {
        indent: 2,
        lineWidth: 120,
        noRefs: true,
        sortKeys: false
    });
    
    console.log('Generated YAML:');
    console.log(yamlContent);
    
    // Verify that websocketToken is included in YAML
    if (yamlContent.includes('websocketToken:')) {
        console.log('‚úÖ SUCCESS: websocketToken field is present in YAML');
    } else {
        console.log('‚ùå FAIL: websocketToken field is missing from YAML');
        process.exit(1);
    }
    
    // Verify the token value is in YAML
    if (yamlContent.includes('mock-jwt-token-agent-test-001-12345-67890')) {
        console.log('‚úÖ SUCCESS: websocketToken value is present in YAML');
    } else {
        console.log('‚ùå FAIL: websocketToken value is missing from YAML');
        process.exit(1);
    }
    
    console.log('YAML generation test passed! üéâ');
    
} catch (error) {
    console.error('Error generating YAML:', error);
    process.exit(1);
}